<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register - CommunityConnect</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background: #f8f9fa;
    }
    .register-container {
      max-width: 950px;
      margin: 60px auto;
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 32px;
    }
    .card {
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(44,62,80,.1);
      border: none;
    }
    .location-panel {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 16px rgba(44,62,80,.08);
      padding: 24px;
      width: 350px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #map {
      height: 210px;
      width: 100%;
      border-radius: 12px;
    }
    @media (max-width: 900px) {
      .register-container {
        flex-direction: column;
        align-items: center;
      }
      .location-panel, .card {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="register-container">
    <div class="card p-4" style="width: 400px;">
      <h3 class="text-center mb-3">Register</h3>
      <form id="register-form">
        <div class="mb-3">
          <label for="name">Name</label>
          <input type="text" id="name" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="email">Email</label>
          <input type="email" id="email" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="role">Role</label>
          <select id="role" class="form-select" required>
            <option value="user" selected>User</option>
            <option value="volunteer">Volunteer</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="password">Password</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <input type="hidden" id="latitude" name="latitude" required>
        <input type="hidden" id="longitude" name="longitude" required>
        <p id="error-message" class="text-danger text-center mt-2"></p>
        <button type="submit" class="btn btn-success w-100">Register</button>
      </form>
      <p class="text-center mt-3">Already have an account? <a href="login.html">Login</a></p>
    </div>
    <div class="location-panel">
      <label class="mb-1" style="font-weight:600;">Select Your Location</label>
      <div id="map" class="mb-2"></div>
      <div class="d-flex justify-content-between w-100 mt-2">
        <div style="width:49%;">
          <label for="latitude" class="small">Latitude</label>
          <input type="text" id="display-latitude" class="form-control form-control-sm" readonly>
        </div>
        <div style="width:49%;">
          <label for="longitude" class="small">Longitude</label>
          <input type="text" id="display-longitude" class="form-control form-control-sm" readonly>
        </div>
      </div>
    </div>
  </div>

  <script src="js/script.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([22.5726, 88.3639], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    var marker;
    map.on('click', function(e) {
      if (marker) { map.removeLayer(marker); }
      marker = L.marker(e.latlng).addTo(map);
      document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
      document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
      document.getElementById('display-latitude').value = e.latlng.lat.toFixed(6);
      document.getElementById('display-longitude').value = e.latlng.lng.toFixed(6);
    });

    document.getElementById('register-form').addEventListener('submit', async function(e){
  e.preventDefault();

  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const role = document.getElementById('role').value;
  const password = document.getElementById('password').value;
  const latitude = document.getElementById('latitude').value;
  const longitude = document.getElementById('longitude').value;

  if (!latitude || !longitude) {
    document.getElementById('error-message').innerText = 'Please select your location on the map.';
    return;
  }

  const payload = {
    name,
    email,
    role,
    password,
    latitude: parseFloat(latitude),
    longitude: parseFloat(longitude)
  };

  try {
    const res = await fetch('http://localhost:5000/api/users/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (res.ok) {
      alert('Registration successful!');
      window.location.href = 'login.html';
    } else {
      document.getElementById('error-message').innerText = data.message || 'Registration failed';
    }
  } catch(err) {
    document.getElementById('error-message').innerText = 'Server error, please try again later';
  }
});

  </script>
</body>
</html>
