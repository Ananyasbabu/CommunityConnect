<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .profile-picture-navbar {
            width: 40px;
            height: 40px;
            border-radius: 50%; /* This makes the image a circle */
            object-fit: cover;   /* This prevents the image from stretching */
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">

   <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="index.html">
            <img src="favicon.ico" alt="Logo" style="width: 30px; height: 30px; margin-right: 10px;">
            CommunityConnect
        </a>

        <div class="d-flex align-items-center ms-auto">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
            </ul>

            <div class="dropdown ms-3">
                <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <img 
                        src="https://t4.ftcdn.net/jpg/00/64/67/63/360_F_64676383_LdbmhiNM6Ypzb3FM4PPuFP9rHe7ri8Ju.jpg" 
                        id="navbarProfileImage"
                        class="profile-picture-navbar" 
                        alt="User Profile"
                    >
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item active" href="profile.html">Profile</a></li>
                    <li><a class="dropdown-item" href="settings.html">Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logout-button">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">User Dashboard</h2>
            <a href="createhelp.html" class="btn btn-primary fw-bold">
                Create Help Request
            </a>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">My Profile</div>
            <div class="card-body">
                <p><strong>Name:</strong> <span id="userName">Loading...</span></p>
                <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">Help Requests</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Urgency</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Contact</th>
                                <th>Address</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="requests-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // document.addEventListener('DOMContentLoaded', () => {
        //     const token = localStorage.getItem('token');
        //     if (!token) {
        //         window.location.href = '/login.html';
        //         return;
        //     }

        //     // Populate user's name and email on the page
        //     populateUserProfile(token);
            
        //     // Fetch nearby requests for the table
        //     fetchNearbyRequests();

        //     // Add event listener for the new logout button in the dropdown
        //     const logoutButton = document.getElementById('logout-button');
        //     if (logoutButton) {
        //         logoutButton.addEventListener('click', (e) => {
        //             e.preventDefault(); // Prevent the link from navigating anywhere
        //             localStorage.removeItem('token'); // Clear the session
        //             window.location.href = '/login.html'; // Redirect to the login page
        //         });
        //     }
        // });

        function populateUserProfile(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('userName').textContent = payload.name || 'N/A';
                document.getElementById('userEmail').textContent = payload.email || 'N/A';
                document.getElementById('navbarProfileImage').src = payload.profile_image_url || 'https://t4.ftcdn.net/jpg/00/64/67/63/360_F_64676383_LdbmhiNM6Ypzb3FM4PPuFP9rHe7ri8Ju.jpg';
            } catch (error) {
                console.error('Failed to decode token:', error);
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        function fetchNearbyRequests() {
            if (!navigator.geolocation) {
                return alert("Geolocation is not supported by your browser.");
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    const response = await fetch(`/api/requests?lat=${latitude}&lon=${longitude}`);
                    if (!response.ok) throw new Error('Failed to fetch requests.');
                    const requests = await response.json();
                    displayRequests(requests);
                } catch (error) {
                    console.error('Error:', error);
                    const tableBody = document.getElementById('requests-table-body');
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Could not load requests.</td></tr>';
                }
            }, () => {
                alert("Unable to retrieve your location.");
                const tableBody = document.getElementById('requests-table-body');
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Location access denied.</td></tr>';
            });
        }

        function displayRequests(requests) {
            const tableBody = document.getElementById('requests-table-body');
            tableBody.innerHTML = ''; 

            if (requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No help requests found nearby.</td></tr>';
                return;
            }

            requests.forEach(req => {
                const urgencyClass = req.urgency === 'emergency' ? 'text-danger fw-bold' : '';
                const row = `
                    <tr>
                        <td class="${urgencyClass}">${req.urgency.charAt(0).toUpperCase() + req.urgency.slice(1)}</td>
                        <td>${req.title}</td>
                        <td>${req.category}</td>
                        <td>${req.contact}</td>
                        <td>${req.address || 'N/A'}</td>
                        <td>${new Date(req.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // for real-time updates using Socket.IO
document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
            return;
        }

        // --- Standard Page Logic ---
        populateUserProfile(token);
        fetchNearbyRequests();

        // Logout Button
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            });
        }

        // --- Socket.IO Real-time Logic ---
        try {
            const socket = io("http://localhost:5000"); // Your backend URL
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.id;

            // Join the private room for this user
            socket.emit('join-room', userId);

            // Listen for new help requests (if you are a volunteer)
            socket.on('new-help-request', (requestData) => {
                // You should add a check here to see if the user is a volunteer
                // if (payload.role === 'volunteer') { ... }
                
                if (confirm(`${requestData.name} from ${requestData.location} needs help. Do you want to accept?`)) {
                    socket.emit('request-accepted', { requestId: requestData.id, volunteerId: userId });
                } else {
                    // Do nothing
                }
            });

            // Listen for updates on your *own* created request
            socket.on('request-timeout', (data) => {
                alert("Sorry, no volunteer is accepting your request at this time.");
            });

            socket.on('your-request-accepted', (data) => {
                alert(`A volunteer has accepted your request!`);
            });

        } catch (error) {
            console.error('Socket.IO connection or token decoding error:', error);
        }
    });
    </script>
</body>
</html>