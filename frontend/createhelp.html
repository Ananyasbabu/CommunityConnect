<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Help Request | CommunityConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --cc-bg: #0f172a;
      --cc-accent: #0d6efd;
      --cc-soft: #f8fafc;
      --cc-muted: #6c757d;
    }

    body {
      background: #ffffff;
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
    }

    .navbar {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .hero-section {
      background: linear-gradient(135deg, #501221 0%, #7f69a2 100%);
      color: #fff;
      padding: 48px 0;
      text-align: center;
    }

    .hero-section h1 {
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .page-card {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      padding: 1.5rem;
    }

    .section-title {
      font-weight: 700;
    }

    .form-label {
      font-weight: 600;
    }

    .hint {
      font-size: 0.9rem;
      color: var(--cc-muted);
    }

    .map-wrap {
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 0.75rem;
      overflow: hidden;
      background: var(--cc-soft);
    }

    #map {
      width: 100%;
      height: 380px;
    }

    .badge-legend .badge {
      font-size: 0.8rem;
    }

    .required::after {
      content: " *";
      color: #dc3545;
    }

    footer {
      margin-top: 48px;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="index.html">CommunityConnect</a>
    <div class="ms-auto d-flex gap-2">
      <a href="index.html" class="btn btn-outline-light">Home</a>
      <a href="login.html" class="btn btn-outline-light">Login</a>
    </div>
  </nav>

  <header class="hero-section">
    <div class="container">
      <h1>Create Help Request</h1>
      <p class="mb-0">Post a request so nearby volunteers can find and assist you quickly.</p>
    </div>
  </header>

  <main class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-9">
        <div class="page-card p-4 p-md-5">
          <h2 class="section-title mb-4">Request Details</h2>

          <div id="formAlert" class="alert d-none" role="alert"></div>

          <form id="helpRequestForm" enctype="multipart/form-data" novalidate>
            <div class="row g-4">

              <div class="col-md-8">
                <label class="form-label required" for="title">Title</label>
                <input
                  class="form-control"
                  id="title"
                  name="title"
                  type="text"
                  placeholder="e.g., Urgent O+ Blood Needed at KIMS Hospital"
                  required
                  maxlength="120"
                />
                <div class="hint mt-1">Keep it clear and concise.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label required" for="category">Category</label>
                <select class="form-select" id="category" name="category" required>
                  <option value="">Select</option>
                  <option>Blood</option>
                  <option>Food</option>
                  <option>Rescue</option>
                  <option>Lost &amp; Found</option>
                  <option>Other</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="urgency">Urgency</label>
                <select class="form-select" id="urgency" name="urgency" required>
                  <option value="normal">Normal</option>
                  <option value="emergency">Emergency</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label required" for="description">Description</label>
                <textarea
                  class="form-control"
                  id="description"
                  name="description"
                  rows="5"
                  placeholder="Share the details: who needs help, what exactly is needed, any time constraints, etc."
                  required
                ></textarea>
                <div class="hint mt-1">Avoid sharing sensitive personal info.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="contact">Contact</label>
                <input
                  class="form-control"
                  id="contact"
                  name="contact"
                  type="text"
                  placeholder="Phone or email"
                  required
                  maxlength="80"
                />
                <div class="hint mt-1">This will be visible on the post.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="address">Address / Landmark</label>
                <input
                  class="form-control"
                  id="address"
                  name="address"
                  type="text"
                  placeholder="Optional: Hospital name, street, area"
                />
              </div>

              <div class="col-12" id="photoUploadContainer" style="display:none;">
                <label class="form-label" for="photo">Upload Photo (Lost &amp; Found)</label>
                <input class="form-control" type="file" id="photo" name="photo" accept="image/*" />
                <div class="hint mt-1">Add a clear picture to help locate the lost item or pet.</div>
              </div>

              <div class="col-12">
                <label class="form-label required">Pick Location on Map</label>
                <div class="map-wrap">
                  <div id="map"></div>
                </div>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <small class="hint">Click on the map to drop/move the pin. Latitude and longitude will be auto-filled.</small>
                  <div class="badge-legend">
                    
                  </div>
                </div>
              </div>

              <input type="hidden" id="latitude" name="latitude" />
              <input type="hidden" id="longitude" name="longitude" />

              <div class="col-12 d-flex gap-3 mt-2">
                <button type="submit" class="btn btn-primary">Submit Request</button>
                <button type="reset" class="btn btn-outline-secondary" id="resetBtn">Reset</button>
              </div>

            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-white text-center p-3">
    &copy; 2025 CommunityConnect | Local Help Portal
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map, marker;

    function initMap() {
      // Default to Bangalore in case location fails
      let startCoords = [12.9716, 77.5946];
      map = L.map('map').setView(startCoords, 13);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(map);

      // Add draggable marker at startCoords
      marker = L.marker(startCoords, { draggable: true }).addTo(map);

      // Attempt to get live location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            startCoords = [
              position.coords.latitude,
              position.coords.longitude
            ];
            map.setView(startCoords, 13);
            marker.setLatLng(startCoords);
            setLatLng(marker.getLatLng());
          },
          (error) => {
            console.error("Error fetching location:", error.message);
            setLatLng(marker.getLatLng()); // Set with default coords if geolocation fails
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser.");
        setLatLng(marker.getLatLng()); // Set with default coords if not supported
      }

      // Update inputs when marker dragged
      marker.on('dragend', function (e) {
        setLatLng(e.target.getLatLng());
      });

      // Update marker and inputs when map is clicked
      map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        setLatLng(e.latlng);
      });
    }

    // Set the hidden latitude and longitude inputs
    function setLatLng(latlng) {
      document.getElementById('latitude').value = latlng.lat.toFixed(6);
      document.getElementById('longitude').value = latlng.lng.toFixed(6);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
  if (!token) {
    alert('Please login to create a post');
    window.location.href = 'login.html';
    return;
  }
      initMap();

      const category = document.getElementById('category');
      const photoUploadContainer = document.getElementById('photoUploadContainer');
      const form = document.getElementById('helpRequestForm');
      const alertBox = document.getElementById('formAlert');

      // Show photo upload only for Lost & Found category
      category.addEventListener('change', () => {
        photoUploadContainer.style.display =
          category.value === 'Lost & Found' ? 'block' : 'none';
      });

      // Handle form submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
          showAlert('Please fill all required fields.', 'danger');
          form.classList.add('was-validated');
          return;
        }

        const formData = new FormData(form);
        const token = localStorage.getItem('token');

        fetch('http://localhost:5000/api/requests', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
          body: formData,
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            if (data.message) {
              showAlert(data.message, 'success');
              form.reset();
              marker.setLatLng([12.9716, 77.5946]);
              setLatLng(marker.getLatLng());
            }
          })
          .catch((error) => {
            console.error('Fetch error:', error);
            showAlert('Submit failed. Please try again later.', 'danger');
          });
      });

      // Reset button handler
      document.getElementById('resetBtn').addEventListener('click', () => {
        showAlert('', '');
        form.classList.remove('was-validated');
        marker.setLatLng([12.9716, 77.5946]);
        setLatLng(marker.getLatLng());
      });

      function showAlert(message, type) {
        if (!message) {
          alertBox.className = 'alert d-none';
          alertBox.textContent = '';
          return;
        }
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
      }
    });

    // for message socket.io
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) return;

    // Connect to the Socket.IO server
    const socket = io("http://localhost:5000"); // Your backend URL

    // Decode token to get user ID
    const payload = JSON.parse(atob(token.split('.')[1]));
    const userId = payload.id;

    // Tell the server to put this socket in a room named after the user ID
    socket.emit('join-room', userId);

    // --- This is where the magic happens ---
    // Listen for new help requests (if you are a volunteer)
    socket.on('new-help-request', (requestData) => {
        // Show a pop-up to the volunteer
        if (confirm(`${requestData.name} from ${requestData.location} needs help. Do you want to accept?`)) {
            socket.emit('request-accepted', { requestId: requestData.id, volunteerId: userId });
        } else {
            // Do nothing or emit a 'request-rejected' event
        }
    });

    // Listen for updates on your own request
    socket.on('request-timeout', (data) => {
        alert("Sorry, no volunteer is accepting your request at this time.");
    });

    socket.on('your-request-accepted', (data) => {
        alert(`A volunteer has accepted your request!`);
    });
});
  </script>
</body>
</html>